@if (loading()) {
  <p-skeleton height="2rem" width="200px" class="mb-4" />
  <div class="grid grid-cols-2 gap-8">
    <p-skeleton height="300px" />
    <p-skeleton height="300px" />
    <p-skeleton height="300px" />
    <p-skeleton height="300px" />
  </div>
} @else if (policy(); as p) {
  <div class="grid grid-cols-2 items-center mb-4">
    <h1>Полис {{p.series}}-{{p.number}}</h1>
    <a [routerLink]="['/policies', p.id, 'edit']" class="justify-self-end" pButton>
      <i class="pi pi-pencil"></i>
      Редактировать
    </a>
  </div>
  <div class="grid grid-cols-2 gap-8 items-start">
    <p-panel header="Общие данные">
      <div class="grid grid-cols-2 gap-4 p-4">
        <span class="text-color-secondary">Серия:</span>
        <span>{{p.series}}</span>
        <span class="text-color-secondary">Номер:</span>
        <span>{{p.number}}</span>
        <span class="text-color-secondary">Дата начала:</span>
        <span>{{p.start_date | date:'mediumDate'}}</span>
        <span class="text-color-secondary">Дата окончания:</span>
        <span>{{p.end_date ? (p.end_date | date:'mediumDate') : '-'}}</span>
        <span class="text-color-secondary">Тип:</span>
        <span>{{p.policy_type | policyTypeLocal}}</span>
        <span class="text-color-secondary">Статус:</span>
        <p-tag [value]="p.status | policyStatusLocal" [severity]="p.status | policyStatusSeverity"/>
        <span class="text-color-secondary">Агенты:</span>
        <span>{{formatAgentNames(p.agents)}}</span>
      </div>
    </p-panel>
    <p-panel header="Страхователь">
      <div class="grid grid-cols-2 gap-4 p-4">
        <span class="text-color-secondary">Имя:</span>
        <span>
         {{p.holder.last_name}} {{p.holder.first_name}} {{p.holder.patronymic_name}}
          <a [routerLink]="['/people', p.holder.id]" pButton [text]="true" size="small">
            <i class="pi pi-eye"></i>
          </a>
        </span>
        <span class="text-color-secondary">Пол:</span>
        <span>{{p.holder.sex | sexLocal}}</span>
        <span class="text-color-secondary">Дата рождения:</span>
        <span>{{p.holder.birth_date | date:'mediumDate'}}</span>
        <span class="text-color-secondary">ИНН:</span>
        <span>{{p.holder.tax_number}}</span>
        <span class="text-color-secondary">Телефон:</span>
        <span>{{p.holder.phone}}</span>
        @if (p.holder.phone2) {
          <span class="text-color-secondary">Телефон 2:</span>
          <span>{{p.holder.phone2}}</span>
        }
        <span class="text-color-secondary">Email:</span>
        <span>{{p.holder.email}}</span>
      </div>
    </p-panel>
    @switch (p.policy_type) {
      @case ('GreenCard') {
        <p-panel header="Детали зеленой карты">
          <div class="grid grid-cols-2 gap-4 p-4">
            <span class="text-color-secondary">Территория:</span>
            <span>{{p.territory}}</span>
            <span class="text-color-secondary">Срок:</span>
            <span>{{p.period_in_units}} {{p.period_unit | periodUnitLocal}}</span>
            <span class="text-color-secondary">Премия:</span>
            <span>{{p.premium}}</span>
          </div>
        </p-panel>
        <ng-container *ngTemplateOutlet="carPanel; context: {car: p.car}"/>
      }
      @case ('Medassistance') {
        <p-panel header="Детали медассистанс">
          <div class="grid grid-cols-2 gap-4 p-4">
            <span class="text-color-secondary">Территория:</span>
            <span>{{p.territory}}</span>
            <span class="text-color-secondary">Срок (дни):</span>
            <span>{{p.period_days}}</span>
            <span class="text-color-secondary">Премия:</span>
            <span>{{p.premium}}</span>
            <span class="text-color-secondary">Выплата:</span>
            <span>{{p.payout}}</span>
            <span class="text-color-secondary">Программа:</span>
            <span>{{p.program}}</span>
          </div>
        </p-panel>
        <p-panel header="Застрахованные">
          <div class="p-4">
            @for (member of p.members; track member.id; let i = $index) {
              <div class="grid grid-cols-2 gap-4 mb-4 pb-4" [class.border-b]="i < p.members.length - 1">
                <span class="text-color-secondary">Имя:</span>
                <span>
                  {{member.first_name}} {{member.last_name}}
                  <a [routerLink]="['/people', member.id]" pButton [text]="true" size="small">
                    <i class="pi pi-eye"></i>
                  </a>
                </span>
                <span class="text-color-secondary">Телефон:</span>
                <span>{{member.phone}}</span>
                <span class="text-color-secondary">Email:</span>
                <span>{{member.email}}</span>
              </div>
            }
          </div>
        </p-panel>
      }
      @case ('Osago') {
        <p-panel header="Детали ОСАГО">
          <div class="grid grid-cols-2 gap-4 p-4">
            <span class="text-color-secondary">Зона:</span>
            <span>{{p.zone | osagoZoneLocal}}</span>
            <span class="text-color-secondary">Срок:</span>
            <span>{{p.period_in_units}} {{p.period_unit | periodUnitLocal}}</span>
            <span class="text-color-secondary">Премия:</span>
            <span>{{p.premium}}</span>
            <span class="text-color-secondary">Льгота:</span>
            <span>{{p.exempt}}</span>
          </div>
        </p-panel>
        <ng-container *ngTemplateOutlet="carPanel; context: {car: p.car}"/>
      }
    }
  </div>
}

<ng-template #carPanel let-car="car">
  <p-panel header="Автомобиль">
    <div class="grid grid-cols-2 gap-4 p-4">
      <span class="text-color-secondary">Марка:</span>
      <span>{{car.make}}</span>
      <span class="text-color-secondary">Модель:</span>
      <span>{{car.model}}</span>
      <span class="text-color-secondary">Год:</span>
      <span>{{car.year}}</span>
      <span class="text-color-secondary">Шасси:</span>
      <span>{{car.chassis}}</span>
      <span class="text-color-secondary">Регистрация:</span>
      <span>{{car.registration}}</span>
      <span class="text-color-secondary">Номер:</span>
      <span>{{car.plate}}</span>
      <span class="text-color-secondary">Объем двигателя (л):</span>
      <span>{{car.engine_displacement_litres}}</span>
      <span class="text-color-secondary">Пробег (км):</span>
      <span>{{car.mileage_km}}</span>
      <span class="text-color-secondary">Масса без нагрузки (кг):</span>
      <span>{{car.unladen_weight}}</span>
      <span class="text-color-secondary">Масса с нагрузкой (кг):</span>
      <span>{{car.laden_weight}}</span>
      <span class="text-color-secondary">Количество мест:</span>
      <span>{{car.seats}}</span>
    </div>
  </p-panel>
</ng-template>
